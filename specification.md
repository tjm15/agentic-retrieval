Okay, let's outline how the `final_report` (the one printed at the end, generated by `MRMOrchestrator.get_final_report()` which uses `_build_final_report_object()`) **should ideally be structured** for maximum utility, explainability, and resemblance to a professional planning officer's report.

The current output shows a nested JSON reflecting the `ReasoningNode` tree, which is good for programmatic access and debugging. However, for a human-readable report or a system that then *formats* this into a document, we'd expect a richer structure within each node's output, particularly in `final_synthesized_text` and `final_structured_data`.

**Ideal Final Report Structure (Conceptual JSON Representation):**

The `get_final_report()` method currently builds a structure like this:

```json
{
  "report_id": "ROOT_Default_MajorHybrid_ECDC_EarlsCourt_App", // More specific ID
  "application_refs": ["ECDC_EarlsCourt_App"],
  "report_type": "Default_MajorHybrid",
  "overall_status": "COMPLETED_SUCCESS", // Or FAILED, COMPLETED_WITH_CLARIFICATION
  "overall_confidence": 0.78, // Aggregated from root node
  "processing_summary": { // From MRMOrchestrator metadata
      "total_nodes_processed": 35, // Including dynamic MCs
      "iterations": 4,
      "total_elapsed_seconds": 120.5,
      "llm_calls_made": {"intent_definition": 35, "node_synthesis": 30, "agent_calls": 5, "scan": 1},
      "cache_hits": {"intent_definition": 5, "node_synthesis": 3, "agent_calls": 1}
  },
  "sections": { // Corresponds to top-level ReasoningNodes (children of root)
    "1.0_SiteAndApplication": {
      "node_id": "ROOT_Default_MajorHybrid/1.0_SiteAndApplication",
      "description": "Site Description, Proposal Details & Planning History",
      "status": "COMPLETED_SUCCESS",
      "confidence_score": 0.85,
      "synthesized_text_for_report_section": "...", // Prose generated by this node's summary intent
      "structured_data_summary": { /* Optional summary of its children's structured data */ },
      "provenance_intent_ids": ["..."],
      "sub_sections": {
        "1.1_SiteLocationAndDescription": {
          "node_id": "ROOT_Default_MajorHybrid/1.0_SiteAndApplication/1.1_SiteLocationAndDescription",
          "description": "Site Location, Existing Conditions, and Surrounding Area Character",
          "status": "COMPLETED_SUCCESS",
          "confidence_score": 0.9,
          "synthesized_text_for_report_section": "The application site, known as ECDC Earls Court (Application Ref: ECDC_EarlsCourt_App), is located at [Full Address]. It covers an area of approximately 18 hectares, straddling the Royal Borough of Kensington and Chelsea (approx. 8ha) and the London Borough of Hammersmith and Fulham (approx. 10ha). The site is a significant brownfield opportunity area...PTAL ratings range from 3 to 6b... The surrounding area is characterized by [description] to the north, [description] to the east... Key constraints include [Flood Zone X, proximity to Y Conservation Area].",
          "structured_data": { // This comes from intent.data_requirements.schema fulfillment
            "full_site_address": "Earls Court Exhibition Centre, Warwick Road, London, SW5 9TA",
            "total_site_area_hectares": 18.0,
            "breakdown_area_rbkc_lbhf_hectares": "RBKC: 8.1ha, LBHF: 9.9ha",
            "current_and_recent_site_uses_summary": "Previously the Earls Court Exhibition Centres, now largely cleared. Some ancillary structures and Lillie Bridge Depot remain partially operational.",
            "description_of_surroundings_character": "Mixed residential densities, commercial frontages along Warwick Road and Old Brompton Road, transport infrastructure.",
            "key_planning_designations_list": [
              {"designation": "Opportunity Area (Earl's Court and West Kensington)", "source": "London Plan Policy SD1", "implications": "Strategic site for housing and employment growth."},
              {"designation": "PTAL Range", "value": "3-6b", "commentary": "Good to excellent public transport accessibility."},
              {"designation": "Flood Zone", "value": "Zone 1 (low risk) with areas of Zone 2/3 surface water", "commentary": "FRA required."}
            ],
            "relevant_site_location_plan_doc_refs": ["UserGuide_p9_FigX", "DAS_Vol1_Fig2.1"]
          },
          "provenance_intent_ids": ["uuid-of-intent-for-1.1"]
        },
        "1.2_ProposalInDetail": {
          // ... similar structure with detailed synthesized_text and structured_data specific to proposal details ...
          "structured_data": {
            "hybrid_application_summary": "The application seeks full planning permission for Phase 1A plots (ECO5, WBO3, etc.) and outline permission for the remainder of the site, governed by parameter plans and a design code.",
            "detailed_plots_summary_table": [ /* list of plot details */ ],
            "outline_component_summary": { /* max GEA, control doc refs */ },
            "overall_development_quanta_table": { /* total homes, affordable %, office sqm etc. */ },
            "phasing_strategy_summary": { /* total years, Phase 1 deliverables */ }
          }
        },
        // ... other sub-sections for 1.0 ...
      }
    },
    "4.0_AssessmentOfMaterialConsiderations": {
      "node_id": "ROOT_Default_MajorHybrid/4.0_AssessmentOfMaterialConsiderations",
      "description": "Officer's Assessment of Material Planning Considerations",
      "status": "COMPLETED_SUCCESS",
      "confidence_score": 0.75, // Aggregated from children
      "synthesized_text_for_report_section": "This section assesses the key material planning considerations arising from the proposed development. Each consideration has been evaluated against relevant national, regional, and local planning policies, taking into account submitted evidence and consultation responses. [This would be a summary generated by this parent node's own synthesis intent, drawing from its children's outputs].",
      "structured_data_summary": {
          "material_considerations_assessed_count": 8, // Example
          "overall_compliance_snapshot": {"largely_compliant": 6, "issues_requiring_mitigation_or_conditions": 2, "significant_conflict": 0}
      },
      "provenance_intent_ids": ["uuid-of-summary-intent-for-4.0"],
      "sub_sections": { // These are the dynamically generated MC nodes
        "HousingDelivery": {
          "node_id": "ROOT_Default_MajorHybrid/4.0_AssessmentOfMaterialConsiderations/HousingDelivery",
          "description": "Housing Delivery: Quantum, Mix, Affordability, Density, and Standards for ECDC_EarlsCourt_App",
          "status": "COMPLETED_SUCCESS",
          "confidence_score": 0.8,
          "synthesized_text_for_report_section": "The proposal would deliver up to 3,950 new homes, making a significant contribution to housing supply. An overall target of 35% affordable housing is proposed, split across [Social Rent %, Intermediate %]. This [meets/falls short of/exceeds] the Local Plan target of X% and the London Plan's strategic target. The unit mix provides [summary of 1,2,3,4+ bed units] which [addresses/partially addresses] identified local needs for family housing. Density levels at [X dph / Y hrh] are considered [appropriate/high/low] for this Opportunity Area location with good PTAL, aligning with design-led intensification principles. All units are stated to meet or exceed National Described Space Standards. Viability information [has/has not] been provided to justify the affordable housing offer.",
          "structured_data": { // Output from the HousingDelivery intent's data_requirements_schema
            "total_homes_proposed_assessment": {"value": 3950, "net_gain": 3950, "compliance_with_oa_target_commentary": "Contributes significantly to OA targets, though specific OAPF targets may need verification."},
            "affordable_housing_assessment": {"proposed_percentage_units_and_hr": "35% by unit, 33% by habitable room (example)", "policy_target_percentage": "RBKC: 35%, LBHF: 50% (blended target needed)", "gap_or_compliance_commentary": "Meets RBKC, further discussion needed for LBHF portion or overall blended compliance. Viability to be reviewed.", "tenure_split_proposed_social_intermediate_shared": "Approx. 70% Social/London Affordable Rent, 30% Intermediate (Shared Ownership/LDR)."},
            "housing_mix_assessment_by_bedroom_size": {"1_bed": "30%", "2_bed": "40%", "3_bed": "25%", "4_bed_plus": "5%", "family_housing_commentary": "Good provision of 3+ bed units contributing to family housing needs."},
            "density_assessment_dph_and_hrh": "Overall: ~200 dph, ~650 hrh. Varies by character area. Considered acceptable for an OA subject to high design quality.",
            "internal_space_standards_compliance_statement": "Applicant confirms all units meet or exceed NDSS. To be secured by condition."
          },
          "relevant_policies_considered": ["NPPF_Ch5", "LondonPlan_H1", "LondonPlan_H5", "RBKC_CH1", "LBHF_HNA"], // List of policy IDs this assessment focused on
          "key_evidence_reviewed": ["Housing Statement Rev B (DocRef: HS001)", "Development Specification App. C (DocRef: DS003)"],
          "consultation_points_addressed": ["Public concern regarding affordability levels.", "GLA comments on tenure split."],
          "provenance_intent_ids": ["uuid-of-intent-for-HousingDelivery"]
        },
        "DesignTownscapeHeritage": {
          // ... similar detailed structure for design, townscape, and heritage, including agent findings if an agent ran ...
          "structured_data": {
              "architectural_approach_summary": "The detailed plots (ECO5, WBO3 etc.) propose a contemporary interpretation of Art Deco and Art Moderne principles, using brick, metal, and stone. The outline components will be governed by the Design Code.",
              "urban_design_layout_assessment": "A clear hierarchy of streets and spaces is proposed, with a central public park (The Table) and improved permeability. Active frontages are proposed along key routes.",
              "scale_massing_height_assessment_in_context": "Building heights range significantly, with taller elements marking key nodes and responding to transport hubs. Parameter plans control maximum AODs. Transition to surrounding lower-rise areas needs careful management.",
              // ... heritage assessment details ...
              "agent_report_summary_if_applicable": { // If an agent ran
                  "agent_name": "VisualHeritageAssessment_GeminiFlash_V1",
                  "key_findings": "Agent noted positive response to Art Deco cues in detailed plots. Raised concern about potential visual impact of Plot Z on distant views of Conservation Area Y, recommending further CGI verification.",
                  "confidence_in_agent_findings": 0.7 // Conceptual
              }
          }
        },
        // ... other dynamically generated Material Consideration sub-sections ...
      }
    },
    "6.0_PlanningBalanceAndConclusion": {
      "node_id": "ROOT_Default_MajorHybrid/6.0_PlanningBalanceAndConclusion",
      "description": "Overall Planning Balance and Officer's Conclusion",
      "status": "COMPLETED_SUCCESS",
      "confidence_score": 0.82,
      "synthesized_text_for_report_section": "The proposed development offers substantial public benefits, including [Benefit 1 e.g., significant housing delivery with 35% affordable], [Benefit 2 e.g., 12,000 new jobs and economic stimulus], and [Benefit 3 e.g., 20 acres of new public realm]. These benefits weigh heavily in favour of the scheme. Identified harms, such as [Harm 1 e.g., some residual townscape impact on specific views] and [Harm 2 e.g., increased pressure on X tube line during peak hours], have been assessed. Proposed mitigation measures [describe effectiveness]. On balance, and applying the tests in NPPF Paragraph 11, the adverse impacts are not considered to significantly and demonstrably outweigh the benefits when assessed against the development plan as a whole. The proposal is therefore considered to represent sustainable development.",
      "structured_data": {
        "key_public_benefits_identified": [
          {"benefit": "Significant contribution to housing supply (3950 units)", "weight": "Very High", "policy_link": ["NPPF_Ch5", "LP_H1"]},
          {"benefit": "Provision of 35% affordable housing", "weight": "High", "policy_link": ["LP_H5", "LocalPlan_AH"]},
          {"benefit": "Creation of extensive new public realm and green space", "weight": "High", "policy_link": ["NPPF_Ch8", "LP_G_Series"]},
          {"benefit": "Job creation and economic regeneration of an Opportunity Area", "weight": "Very High", "policy_link": ["NPPF_Ch6", "LP_E_Series", "LP_SD1"]}
        ],
        "residual_adverse_impacts_identified": [
          {"impact": "Localized visual impact from taller buildings on some mid-range views towards X.", "mitigation_summary": "Design Code controls, material quality, landscaping.", "residual_harm_level": "Minor Adverse", "weight": "Medium"},
          {"impact": "Increased demand on specific local transport infrastructure (X station, Y bus route).", "mitigation_summary": "S106 contributions, Travel Plan measures.", "residual_harm_level": "Moderate Adverse (manageable)", "weight": "Medium"}
        ],
        "nppf_paragraph_11_test_application": "The development plan is [up-to-date/partially out-of-date regarding X]. Relevant policies [are/are not] a clear reason for refusal. The adverse impacts identified do not significantly and demonstrably outweigh the benefits.",
        "overall_planning_balance_conclusion": "The substantial public benefits offered by this strategic regeneration scheme are considered to outweigh the identified and mitigated harms. The proposal accords with the overarching aims of the development plan and constitutes sustainable development."
      },
      "provenance_intent_ids": ["..."]
    },
    // ... 7.0_Recommendation section ...
  }
}
```

**Key Structural Enhancements in this Ideal Output:**

*   **`report_id`:** More specific, perhaps including application reference.
*   **`overall_confidence`:** An aggregated confidence score for the entire report.
*   **`processing_summary`:** Metadata about the AI's process (node counts, timings, LLM calls, cache hits). This is invaluable for diagnostics and understanding system performance.
*   **For each `ReasoningNode` (`sections` and `sub_sections`):**
    *   `synthesized_text_for_report_section`: This is the primary prose output for that section, intended to be directly usable (with review) in a human-readable officer's report. It should be well-written, referenced (conceptually, if not with explicit footnote markers), and logically structured.
    *   `structured_data`: This is the rich, detailed output corresponding to the `data_requirements_schema` defined in the `Intent` for that node. It contains specific metrics, tables, compliance statements, and analytical points. This data underpins the `synthesized_text`.
    *   `relevant_policies_considered` (Optional): A list of specific policy IDs that were central to the assessment in this node.
    *   `key_evidence_reviewed` (Optional): References to key documents or data sources used for this node's assessment.
    *   `consultation_points_addressed` (Optional): If this node deals with issues raised in consultation, it can summarize how they were addressed.
    *   `agent_report_summary_if_applicable` (Optional): If a subsidiary agent contributed, its key findings and confidence can be embedded here.

**How to Achieve This Richer Output:**

1.  **Refine `IntentDefiner` Prompts:** The meta-prompts that ask Gemini Pro to *define the `Intent` specification* for each node must be very clear about the expected `data_requirements_schema`. The more detailed this schema is, the better Gemini Pro (in the `NodeProcessor`'s synthesis step) can populate it.
2.  **Refine `NodeProcessor` Synthesis Prompts:** The prompt given to Gemini Pro by `NodeProcessor.process_intent` (for the final synthesis of a node's output) must instruct it to:
    *   Generate both the `synthesized_text_for_report_section` (prose).
    *   And populate the `structured_data` according to the `intent.data_requirements.schema`. This might involve asking for the output in a specific JSON format that includes both.
    *   Example: "Your response should be a JSON object with two top-level keys: 'report_text' (containing the narrative assessment) and 'structured_findings' (containing a JSON object matching this schema: {...schema...})."
3.  **Post-Processing by MRM:** The `MRMOrchestrator` might still need to do some minor reformatting or aggregation when constructing the absolute final report from the individual node outputs.

This detailed, structured output makes the AI's reasoning far more transparent, auditable, and directly useful for a planning officer who needs to review, verify, and potentially adopt the AI's draft.